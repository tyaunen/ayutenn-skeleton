# AI_GUIDELINE
AIエージェント向けの開発ガイドラインです。

## タスク遂行フロー
あなたは、以下のフローでタスクを実行すべきです。

### 1. ドキュメント確認
このプロジェクトで仕様されているのは独自フレームワーク(ayutenn)です。
「既存のフレームワークであればこうするのがいいだろう」という推測は避け、わからないことがあれば必ず質問して確度が高い実装をしてください。

ayutennの基本仕様については、.agent/skills/ 配下の各スキルを確認してください。
（ayutenn-request, ayutenn-database, ayutenn-utility, ayutenn-css-layout, ayutenn-css-component）

ディレクトリ構造と、より詳しい仕様ドキュメントのインデックスはこのAGENT.mdにも記載してありますから、それも参照してください。

**特に新しいファイルを追加する際は、かならず根拠となるワークフローとドキュメントを確認してください。**

### プロジェクト ディレクトリ構造
```
/skeleton
├── /app
│   ├── /api              - API処理(JSONレスポンス)
│   ├── /controller       - コントローラー(POST→リダイレクト)
│   ├── /database         - DataManager継承クラス
│   ├── /helper           - 再利用可能なヘルパー
│   ├── /model            - バリデーションルール定義(JSON)
│   ├── /public           - エントリポイントとアセット
│   ├── /routes           - ルート定義
│   └── /views            - ビュー(HTML/PHP)
├── /config               - config.json(環境設定), app.json(アプリ設定)
├── /docs                 - ドキュメント
├── /migrations           - テーブル定義(define/)とDDL(ddl/)
├── /scripts              - ユーティリティスクリプト
├── /storage              - セッション、ログ等(実行時生成)
└── /vendor               - Composer依存
```
詳細: [docs/ayutenn/intro.md](docs/ayutenn/intro.md)

### ドキュメント一覧 (`docs/ayutenn/`)
タスクに関連するドキュメントのみ参照してください。

| ファイル | 内容 |
|---|---|
| intro.md | プロジェクト構造、セットアップ、リクエスト処理の流れ |
| routing.md | ルート定義の書き方、ミドルウェア |
| controller.md | POST処理コントローラーの作成 |
| api.md | JSONレスポンスAPIの作成 |
| view.md | ビューファイルの作成、コンポーネント |
| model.md | バリデーションルール定義(JSON) |
| database.md | DataManager、SQL実行、トランザクション |
| migration.md | テーブル定義JSONとマイグレーション |
| testing.md | PHPUnitテストの書き方 |
| best-practices.md | コーディング規約、設計方針 |

### 2. 不明点の確認
ユーザーの依頼は不透明であったり、正確ではないことがあります。
実装計画に移る前に不明点やあいまいな点を確認することで、確度が高い実装をしてください。

### 3. 実装提案
実装提案をして、ユーザーの許可を得てください。

### 4. タスクの遂行
実装提案に従い、与えられたタスクを実行してください。
実装はシンプルであることが好ましいです。

### 5. テストコードの作成と実行
phpunitによるユニットテストを作成してください。
また、依存するクラスが存在する場合はインテグレーションテストも作成してください。
このプロジェクトではユニットテストより、インテグレーションテストでなるべく実際のアプリの動きを再現して確認することを重要視します。

### 6. セルフレビュー
以下の観点からセルフレビューを行ってください。
- 自分の今回の変更が、全体の処理の流れを複雑化させていないか
- よりシンプルな実装にできないか
- テストが不足していないか

問題がある場合、「3. 実装提案」からプロセスを再度実施してください。

### 7. ドキュメントの更新
あなたが作業した内容に応じて、ドキュメントの更新を行ってください。

## プロジェクト方針
### 車輪の再発明を避ける
既存の処理を利用できないか、また処理を共通化できないか、常に考え続けてください。
処理を共通化出来そうなら、`/app/helper`ディレクトリに格納するのがよいでしょう。

### ドキュメントを育てる
実装中にエラーが起こった、どう実装するか迷った、ユーザーに明らかな間違いの修正を指示された、
そういった場合再発防止策が必要です。対応するドキュメントに、再発防止のためのノウハウを蓄積していってください。
ドキュメントへ追記をしたあとは、そのドキュメント全体を見て情報を整理してください。

### セルフレビューを行う
実装のテストや完了報告を行う前に、自分の実装をレビューしてください。
特にプロジェクト方針である「ドキュメント、サンプル重視」「車輪の再発明を避ける」については注意深くレビューしてください。

## 実装ルール

コードベースの品質を高く保つため、以下の厳格なルールを遵守してください。

### 1. PHP厳格モードと型定義 (必須)
- **Strict Types**: すべてのPHPファイルの先頭（`<?php` の直後）に必ず `declare(strict_types=1);` を記述してください。
- **型宣言**: メソッドの引数、戻り値、クラスプロパティには**必ず**型宣言を行ってください。`mixed`型は極力避け、具体的な型を指定してください。

### 2. ドキュメンテーション (必須)
- **PHPDoc**: クラス、メソッド、プロパティには必ずPHPDocコメントを記述してください。
- **コメント言語**: コメントの説明文は**日本語**で、明確に記述してください。
- `@param`, `@return` には型と説明を記述してください。例外をスローする可能性がある場合は `@throws` を記述してください。

```php
/**
 * ユーザー情報を取得する
 *
 * @param int $userId ユーザーID
 * @return UserEntity|null ユーザーが見つかった場合はエンティティ、なければnull
 * @throws DatabaseException データベース接続エラー時
 */
public function getUser(int $userId): ?UserEntity
```

### 3. コーディングスタイルと品質 (推奨)
- **PSR-12準拠**: コードフォーマットはPSR-12に従ってください。
- **早期リターン (Early Return)**: ネストを深くしないため、条件分岐では早期リターンを使用してください。`else` 句の使用は可能な限り避けてください。
- **メソッドの責任**: 1つのメソッドが長くなりすぎないようにしてください（目安: 50行以内）。複数の責務を持っている場合はprivateメソッド等に分割してください。
- **命名規則**:
  - 変数名やメソッド名は、その役割がひと目で分かる英語名にしてください。
  - **禁止**: `$data`, `$info`, `$temp`, `$obj`, `$arr` などの抽象的すぎる名前。
  - **禁止**: `check()`, `process()` のような何をするか不明確なメソッド名（`isValidUser()`, `processPayment()` のように具体的にする）。
- **マジックナンバー・ストリングの禁止**: コード内に直接数値や文字列リテラルを書かず、クラス定数(`const`)または設定ファイルを使用してください。

### 4. エラーハンドリング
- **ユーザー通知**: `Ayutenn\Core\Session\FlashMessage` を使用してください。
- **例外**: 予期せぬエラーは適切にキャッチし、ログ出力やユーザーへの適切なフィードバックを行ってください。生のエラーメッセージをそのままユーザーに表示しないでください。